<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MyCallCode Ultimate</title>
    <style>
        :root { 
            --glass: rgba(20, 25, 35, 0.95); 
            --accent: #00f2fe; 
            --accent-glow: rgba(0, 242, 254, 0.3);
            --danger: #ff4d4d; 
            --bg: #050505; 
            --text: #e0e6ed;
        }

        * { box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif; -webkit-tap-highlight-color: transparent; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: var(--bg); color: var(--text); overflow: hidden; }

        /* --- SETUP WIZARD --- */
        #wizard-overlay { position: fixed; inset: 0; display: flex; align-items: center; justify-content: center; background: radial-gradient(circle at center, #1a202c 0%, #000000 100%); z-index: 2000; padding: 15px; }
        .card { background: var(--glass); border: 1px solid rgba(255,255,255,0.1); padding: 25px; border-radius: 20px; width: 100%; max-width: 420px; text-align: center; box-shadow: 0 0 40px rgba(0, 242, 254, 0.1); transition: transform 0.3s; }
        .step { display: none; opacity: 0; transition: opacity 0.3s ease; }
        .step.active { display: block; opacity: 1; }
        
        h1 { margin: 0 0 10px 0; background: linear-gradient(to right, #fff, var(--accent)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: 800; letter-spacing: -1px; }
        h3 { color: var(--accent); margin-top: 0; font-weight: 600; }
        p { font-size: 0.9rem; color: #8892b0; margin-bottom: 20px; line-height: 1.5; }

        textarea { width: 100%; height: 100px; background: rgba(0,0,0,0.6); color: var(--accent); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 12px; font-family: 'Courier New', monospace; font-size: 11px; margin: 10px 0; resize: none; outline: none; }
        textarea:focus { border-color: var(--accent); }

        .btn { width: 100%; padding: 14px; border-radius: 12px; border: none; font-weight: 600; cursor: pointer; margin-top: 10px; font-size: 15px; transition: 0.2s; position: relative; overflow: hidden; }
        .btn-main { background: var(--accent); color: #000; box-shadow: 0 4px 15px var(--accent-glow); }
        .btn-main:hover { transform: translateY(-2px); box-shadow: 0 6px 20px var(--accent-glow); }
        .btn-main:disabled { background: #333; color: #666; cursor: not-allowed; transform: none; box-shadow: none; }
        .btn-ghost { background: rgba(255,255,255,0.05); color: #fff; border: 1px solid rgba(255,255,255,0.1); }

        /* Spinner for ICE Gathering */
        .spinner { display: inline-block; width: 12px; height: 12px; border: 2px solid rgba(0,0,0,0.3); border-radius: 50%; border-top-color: #000; animation: spin 1s ease-in-out infinite; margin-right: 8px; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* --- MEETING UI --- */
        #meeting-ui { display: none; width: 100%; height: 100%; position: relative; background: #000; }
        
        /* Video Elements */
        #remoteVideo { width: 100%; height: 100%; object-fit: contain; background: #000; }
        #local-container { position: absolute; width: 120px; height: 160px; bottom: 100px; right: 20px; border-radius: 12px; overflow: hidden; border: 2px solid rgba(255,255,255,0.2); z-index: 10; box-shadow: 0 10px 30px rgba(0,0,0,0.5); cursor: grab; background: #111; touch-action: none; }
        #localVideo { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); pointer-events: none; }

        /* Controls */
        .controls { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); display: flex; gap: 15px; background: rgba(20, 20, 20, 0.8); backdrop-filter: blur(10px); padding: 12px 25px; border-radius: 40px; border: 1px solid rgba(255,255,255,0.1); z-index: 100; }
        .c-btn { width: 50px; height: 50px; border-radius: 50%; border: none; background: #333; color: white; font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .c-btn:active { transform: scale(0.95); }
        .c-btn.active { background: var(--bg); border: 1px solid var(--accent); color: var(--accent); }
        .c-btn.off { background: var(--danger); color: white; border: none; }
        .c-btn-end { background: var(--danger); width: 60px; border-radius: 20px; }

        /* Toast Notification */
        #toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-100px); background: #333; color: white; padding: 10px 20px; border-radius: 50px; font-size: 13px; opacity: 0; transition: 0.3s; z-index: 3000; display: flex; align-items: center; gap: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        #toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }

        /* Connection Status */
        .status-pill { position: absolute; top: 20px; left: 20px; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); padding: 6px 12px; border-radius: 20px; font-size: 11px; color: #aaa; display: flex; align-items: center; gap: 6px; z-index: 100; border: 1px solid rgba(255,255,255,0.05); }
        .dot { width: 8px; height: 8px; background: #666; border-radius: 50%; }
        .dot.green { background: #00fa9a; box-shadow: 0 0 8px #00fa9a; }
        .dot.yellow { background: #ffd700; }

        @media (min-width: 768px) {
            #local-container { width: 240px; height: 160px; bottom: 30px; right: 30px; }
            .controls { bottom: 30px; }
        }
    </style>
</head>
<body>

    <!-- Setup Wizard -->
    <div id="wizard-overlay">
        <div class="card">
            
            <!-- Step 0: Welcome -->
            <div id="step-home" class="step active">
                <h1>MyCallCode</h1>
                <p>Secure, peer-to-peer video calling.<br>No servers. No data collection.</p>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    <button class="btn btn-main" onclick="init('host')">ðŸ“ž Start Call</button>
                    <button class="btn btn-ghost" onclick="init('guest')">ðŸ“© Join Call</button>
                </div>
                <p style="margin-top:20px; font-size:0.75rem; color:#555;">Works on Mobile & PC</p>
            </div>

            <!-- Host Step 1 -->
            <div id="step-host-1" class="step">
                <h3>1. Send Invite</h3>
                <p id="h-status">Gathering network info...<br><span style="font-size:10px; color:var(--accent)">Wait for 100% before copying</span></p>
                <textarea id="h-offer" readonly onclick="this.select()"></textarea>
                <button id="btn-copy-offer" class="btn btn-main" onclick="copyToClip('h-offer')" disabled>
                    <span class="spinner"></span> Wait...
                </button>
                <button class="btn btn-ghost" onclick="goToStep('step-host-2')">Next: I have the Answer</button>
            </div>

            <!-- Host Step 2 -->
            <div id="step-host-2" class="step">
                <h3>2. Connect</h3>
                <p>Paste the code sent back by your guest.</p>
                <textarea id="h-answer-in" placeholder="Paste Guest Code here..."></textarea>
                <button class="btn btn-main" onclick="finalizeHost()">ðŸš€ Connect</button>
                <button class="btn btn-ghost" onclick="goToStep('step-host-1')">Back</button>
            </div>

            <!-- Guest Step 1 -->
            <div id="step-guest-1" class="step">
                <h3>1. Receive Invite</h3>
                <p>Paste the code sent by the host.</p>
                <textarea id="g-offer-in" placeholder="Paste Host Code here..."></textarea>
                <button class="btn btn-main" onclick="processOffer()">Generate Answer</button>
                <button class="btn btn-ghost" onclick="location.reload()">Back</button>
            </div>

            <!-- Guest Step 2 -->
            <div id="step-guest-2" class="step">
                <h3>2. Send Reply</h3>
                <p id="g-status">Optimizing route...</p>
                <textarea id="g-answer-out" readonly onclick="this.select()"></textarea>
                <button id="btn-copy-answer" class="btn btn-main" onclick="copyToClip('g-answer-out')" disabled>
                    <span class="spinner"></span> Wait...
                </button>
                <p style="font-size:11px; margin-top:10px; color:#aaa;">Send this code back to the Host immediately.</p>
            </div>

        </div>
    </div>

    <!-- Main Call Interface -->
    <div id="meeting-ui">
        <div class="status-pill">
            <div id="status-dot" class="dot"></div>
            <span id="status-text">Connecting...</span>
        </div>

        <video id="remoteVideo" autoplay playsinline></video>
        
        <div id="local-container">
            <video id="localVideo" autoplay muted playsinline></video>
        </div>

        <div class="controls">
            <button class="c-btn" id="btn-mic" onclick="toggleTrack('audio')">ðŸŽ¤</button>
            <button class="c-btn" id="btn-cam" onclick="toggleTrack('video')">ðŸ“·</button>
            <button class="c-btn c-btn-end" onclick="hangup()">ðŸ“ž</button>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast">ðŸ“‹ Copied to clipboard!</div>

    <script>
        // CONFIGURATION
        const iceServers = {
            iceServers: [
                { urls: "stun:stun.l.google.com:19302" },
                { urls: "stun:stun1.l.google.com:19302" },
                { urls: "stun:stun2.l.google.com:19302" },
                { urls: "stun:stun.miwifi.com:3478" } // Extra STUN for mobile
            ]
        };

        let pc;
        let localStream;
        let role; // 'host' or 'guest'

        // --- UI FUNCTIONS ---
        function goToStep(id) {
            document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function toast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        }

        async function copyToClip(elemId) {
            const el = document.getElementById(elemId);
            el.select();
            el.setSelectionRange(0, 99999); // Mobile fix
            try {
                await navigator.clipboard.writeText(el.value);
                toast("ðŸ“‹ Code Copied! Send it now.");
            } catch (err) {
                toast("âŒ Auto-copy failed. Please copy manually.");
            }
        }

        // --- WEBRTC CORE ---
        
        async function init(userRole) {
            role = userRole;
            
            // 1. Get Media
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: "user", width: { ideal: 640 }, height: { ideal: 480 } }, 
                    audio: { echoCancellation: true, noiseSuppression: true } 
                });
                document.getElementById('localVideo').srcObject = localStream;
            } catch (e) {
                alert("Camera/Mic access denied. Please allow permissions.");
                return;
            }

            // 2. Create PeerConnection
            pc = new RTCPeerConnection(iceServers);
            
            // Add Tracks
            localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

            // Handle Remote Stream
            pc.ontrack = (event) => {
                const remoteVid = document.getElementById('remoteVideo');
                if (remoteVid.srcObject !== event.streams[0]) {
                    remoteVid.srcObject = event.streams[0];
                    console.log("Remote stream received");
                }
            };

            // Connection State Monitoring
            pc.onconnectionstatechange = () => {
                const state = pc.connectionState;
                console.log("Connection State:", state);
                const dot = document.getElementById('status-dot');
                const txt = document.getElementById('status-text');
                
                if(state === 'connected') {
                    document.getElementById('wizard-overlay').style.display = 'none';
                    document.getElementById('meeting-ui').style.display = 'block';
                    dot.className = "dot green";
                    txt.innerText = "Secure Connection Active";
                } else if (state === 'failed' || state === 'disconnected') {
                    dot.className = "dot";
                    txt.innerText = "Disconnected";
                    // Attempt restart?
                }
            };

            // Logic Split
            if (role === 'host') {
                createOffer();
            } else {
                goToStep('step-guest-1');
            }
        }

        // --- HOST LOGIC ---
        async function createOffer() {
            goToStep('step-host-1');
            
            // Create Data Channel (Required to initiate connection even for just video)
            pc.createDataChannel("chat"); 

            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);
            
            // Wait for ICE Gathering to complete (CRITICAL FOR MOBILE)
            waitForIce(pc, () => {
                const code = btoa(JSON.stringify(pc.localDescription));
                document.getElementById('h-offer').value = code;
                const btn = document.getElementById('btn-copy-offer');
                btn.innerHTML = "ðŸ“‹ Copy Code";
                btn.disabled = false;
                document.getElementById('h-status').innerText = "âœ… Network Ready. Copy code below.";
            });
        }

        async function finalizeHost() {
            const input = document.getElementById('h-answer-in').value.trim();
            if(!input) return alert("Please paste the guest code first!");
            
            try {
                const answerDesc = JSON.parse(atob(input));
                await pc.setRemoteDescription(new RTCSessionDescription(answerDesc));
            } catch(e) {
                alert("Invalid Code. Please check connection.");
            }
        }

        // --- GUEST LOGIC ---
        async function processOffer() {
            const input = document.getElementById('g-offer-in').value.trim();
            if(!input) return alert("Please paste the host code!");

            try {
                const offerDesc = JSON.parse(atob(input));
                await pc.setRemoteDescription(new RTCSessionDescription(offerDesc));
                
                const answer = await pc.createAnswer();
                await pc.setLocalDescription(answer);

                goToStep('step-guest-2');
                
                // Wait for ICE Gathering
                waitForIce(pc, () => {
                    const code = btoa(JSON.stringify(pc.localDescription));
                    document.getElementById('g-answer-out').value = code;
                    const btn = document.getElementById('btn-copy-answer');
                    btn.innerHTML = "ðŸ“‹ Copy Reply Code";
                    btn.disabled = false;
                    document.getElementById('g-status').innerText = "âœ… Ready! Send this back.";
                });

            } catch(e) {
                console.error(e);
                alert("Invalid Code. Try again.");
            }
        }

        // --- HELPER: WAIT FOR ICE ---
        function waitForIce(pc, callback) {
            // If already complete
            if (pc.iceGatheringState === 'complete') {
                callback();
                return;
            }

            // Wait for candidates
            const checkIce = () => {
                if (pc.iceGatheringState === 'complete') {
                    pc.removeEventListener('icegatheringstatechange', checkIce);
                    callback();
                }
            };
            pc.addEventListener('icegatheringstatechange', checkIce);
            
            // Fallback timeout (in case trickle ICE takes too long, just send what we have after 2s)
            setTimeout(() => {
                if(pc.iceGatheringState !== 'complete') {
                    console.warn("ICE gathering timed out, sending partial candidates");
                    callback(); 
                }
            }, 3000); 
        }

        // --- CONTROLS ---
        function toggleTrack(kind) {
            localStream.getTracks().forEach(t => {
                if(t.kind === kind) {
                    t.enabled = !t.enabled;
                    const btn = document.getElementById(kind === 'audio' ? 'btn-mic' : 'btn-cam');
                    btn.classList.toggle('off', !t.enabled);
                }
            });
        }

        function hangup() {
            pc.close();
            location.reload();
        }

        // --- DRAGGABLE LOCAL VIDEO (Mobile Touch Support) ---
        const dragItem = document.getElementById("local-container");
        let active = false;
        let currentX;
        let currentY;
        let initialX;
        let initialY;
        let xOffset = 0;
        let yOffset = 0;

        dragItem.addEventListener("touchstart", dragStart, false);
        dragItem.addEventListener("touchend", dragEnd, false);
        dragItem.addEventListener("touchmove", drag, false);
        dragItem.addEventListener("mousedown", dragStart, false);
        dragItem.addEventListener("mouseup", dragEnd, false);
        dragItem.addEventListener("mousemove", drag, false);

        function dragStart(e) {
            if (e.type === "touchstart") {
                initialX = e.touches[0].clientX - xOffset;
                initialY = e.touches[0].clientY - yOffset;
            } else {
                initialX = e.clientX - xOffset;
                initialY = e.clientY - yOffset;
            }
            if (e.target === dragItem || dragItem.contains(e.target)) active = true;
        }

        function dragEnd(e) {
            initialX = currentX;
            initialY = currentY;
            active = false;
        }

        function drag(e) {
            if (active) {
                e.preventDefault();
                if (e.type === "touchmove") {
                    currentX = e.touches[0].clientX - initialX;
                    currentY = e.touches[0].clientY - initialY;
                } else {
                    currentX = e.clientX - initialX;
                    currentY = e.clientY - initialY;
                }
                xOffset = currentX;
                yOffset = currentY;
                setTranslate(currentX, currentY, dragItem);
            }
        }

        function setTranslate(xPos, yPos, el) {
            el.style.transform = "translate3d(" + xPos + "px, " + yPos + "px, 0)";
        }
    </script>
</body>
</html>
