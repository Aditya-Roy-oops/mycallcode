<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MyCallCode Ultimate</title>
    <!-- LZ-String for compression -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.5.0/lz-string.min.js"></script>
    <!-- QRCode.js for generating QR codes -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <style>
        :root { 
            --glass: rgba(255, 255, 255, 0.1); 
            --glass-strong: rgba(255, 255, 255, 0.2);
            --accent: #00f2fe; 
            --accent-grad: linear-gradient(135deg, #00f2fe 0%, #4facfe 100%);
            --danger: #ff4d4d; 
            --bg: #050505; 
            --panel: #111;
            --text-muted: #888;
        }

        * { box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; -webkit-tap-highlight-color: transparent; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: var(--bg); color: white; overflow: hidden; }

        /* UTILS */
        .hidden { display: none !important; }
        .flex-center { display: flex; align-items: center; justify-content: center; }
        .full-screen { position: fixed; inset: 0; width: 100%; height: 100%; }

        /* --- WIZARD UI --- */
        #wizard { z-index: 2000; background: radial-gradient(circle at center, #1a202c 0%, #000 100%); flex-direction: column; overflow-y: auto; padding: 20px; }
        .card { 
            background: rgba(20, 20, 20, 0.8); 
            backdrop-filter: blur(20px); 
            border: 1px solid var(--glass); 
            padding: 30px; 
            border-radius: 24px; 
            width: 100%; 
            max-width: 500px; 
            box-shadow: 0 0 50px rgba(0, 242, 254, 0.1);
            transition: transform 0.3s ease;
        }
        
        h1 { margin: 0 0 10px 0; background: var(--accent-grad); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-size: 2.5rem; letter-spacing: -1px; text-align: center; }
        p.subtitle { text-align: center; color: var(--text-muted); margin-bottom: 30px; font-size: 0.95rem; }

        .btn-group { display: flex; gap: 10px; margin-top: 20px; }
        .btn { 
            flex: 1; 
            padding: 16px; 
            border-radius: 14px; 
            border: none; 
            font-weight: 600; 
            cursor: pointer; 
            font-size: 1rem; 
            transition: all 0.2s; 
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: var(--accent-grad); color: #000; box-shadow: 0 4px 15px rgba(0, 242, 254, 0.3); }
        .btn-secondary { background: var(--glass); color: white; border: 1px solid var(--glass-strong); }
        .btn-danger { background: rgba(255, 77, 77, 0.2); color: var(--danger); border: 1px solid var(--danger); }

        .input-area { position: relative; margin: 20px 0; }
        textarea { 
            width: 100%; height: 100px; 
            background: #000; color: var(--accent); 
            border: 1px solid var(--glass-strong); 
            border-radius: 12px; padding: 15px; 
            font-family: 'Courier New', monospace; font-size: 12px; 
            resize: none; outline: none;
        }
        textarea:focus { border-color: var(--accent); }

        .qr-container { background: white; padding: 15px; border-radius: 16px; margin: 20px auto; width: fit-content; display: none; }
        .qr-container.show { display: block; animation: popIn 0.3s ease; }
        
        .loading-pulse { 
            display: inline-block; width: 10px; height: 10px; 
            background: var(--accent); border-radius: 50%; 
            animation: pulse 1s infinite; margin-left: 5px; 
        }

        /* --- MAIN CALL UI --- */
        #call-ui { display: none; background: #000; }
        
        .video-grid { 
            width: 100%; height: 100%; 
            display: flex; align-items: center; justify-content: center; 
            position: relative;
        }

        video { width: 100%; height: 100%; object-fit: contain; background: #000; }
        
        /* Draggable Local Video */
        #local-wrapper { 
            position: absolute; bottom: 120px; right: 20px; 
            width: 140px; aspect-ratio: 9/16; 
            border-radius: 18px; overflow: hidden; 
            border: 2px solid rgba(255,255,255,0.2); 
            box-shadow: 0 10px 40px rgba(0,0,0,0.5); 
            cursor: grab; z-index: 10;
            background: #111;
            transition: width 0.3s ease;
        }
        #localVideo { object-fit: cover; transform: scaleX(-1); } /* Mirror local */

        /* Controls */
        .dock { 
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); 
            display: flex; gap: 12px; padding: 12px; 
            background: rgba(20, 20, 20, 0.85); backdrop-filter: blur(16px); 
            border-radius: 24px; border: 1px solid var(--glass); 
            z-index: 100; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        
        .dock-btn { 
            width: 50px; height: 50px; border-radius: 18px; border: none; 
            background: rgba(255,255,255,0.05); color: white; font-size: 20px; 
            cursor: pointer; transition: 0.2s; position: relative;
        }
        .dock-btn:hover { background: rgba(255,255,255,0.15); transform: translateY(-2px); }
        .dock-btn.off { background: var(--danger); color: white; }
        .dock-btn.active { background: var(--accent); color: black; }
        .badge { position: absolute; top: -5px; right: -5px; background: var(--danger); color: white; font-size: 10px; padding: 2px 6px; border-radius: 10px; display: none; }

        /* Chat & File Drawers */
        .drawer { 
            position: absolute; top: 0; right: 0; width: 100%; max-width: 360px; height: 100%; 
            background: rgba(10, 10, 10, 0.95); backdrop-filter: blur(40px); 
            z-index: 50; transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border-left: 1px solid var(--glass); display: flex; flex-direction: column;
        }
        .drawer.open { transform: translateX(0); }
        
        .drawer-header { padding: 20px; border-bottom: 1px solid var(--glass); display: flex; justify-content: space-between; align-items: center; font-weight: bold; letter-spacing: 1px; }
        .chat-content { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 12px; }
        
        .msg { padding: 10px 16px; border-radius: 18px; max-width: 85%; font-size: 14px; line-height: 1.5; word-break: break-word; }
        .msg.sent { background: var(--accent); color: #000; align-self: flex-end; border-bottom-right-radius: 4px; }
        .msg.received { background: #222; color: #fff; align-self: flex-start; border-bottom-left-radius: 4px; border: 1px solid var(--glass); }
        .msg a { color: inherit; text-decoration: underline; font-weight: bold; }
        
        .chat-input-area { padding: 15px; border-top: 1px solid var(--glass); display: flex; gap: 10px; }
        .chat-input { flex: 1; background: #222; border: none; padding: 12px; border-radius: 12px; color: white; outline: none; }

        #file-progress-bar { position: absolute; top: 0; left: 0; height: 3px; background: var(--accent); width: 0%; transition: width 0.2s; z-index: 200; }

        @keyframes pulse { 0% { opacity: 1; transform: scale(1); } 50% { opacity: 0.5; transform: scale(1.2); } 100% { opacity: 1; transform: scale(1); } }
        @keyframes popIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }

        /* Responsive Tweaks */
        @media (min-width: 768px) {
            #local-wrapper { width: 220px; aspect-ratio: 16/9; }
            .dock { bottom: 40px; gap: 20px; padding: 15px 30px; }
        }
    </style>
</head>
<body>

    <!-- WIZARD SCREEN -->
    <div id="wizard" class="full-screen flex-center">
        <div class="card" id="w-intro">
            <h1>MyCallCode</h1>
            <p class="subtitle">Secure ‚Ä¢ Peer-to-Peer ‚Ä¢ Universal</p>
            <div class="btn-group">
                <button class="btn btn-primary" onclick="startFlow('host')">
                    <span>üì°</span> Start New Call
                </button>
                <button class="btn btn-secondary" onclick="startFlow('guest')">
                    <span>üîó</span> Join Call
                </button>
            </div>
            <p style="margin-top:20px; font-size:12px; opacity:0.5; text-align:center;">
                Works on PC & Mobile. No Login Required.
            </p>
        </div>

        <div class="card hidden" id="w-step1">
            <h3 id="step1-title">Generating Secure Link...</h3>
            <p class="subtitle">Please wait while we gather network candidates.</p>
            <div class="flex-center" style="height: 100px;">
                <div class="loading-pulse" style="width: 20px; height: 20px;"></div>
            </div>
        </div>

        <div class="card hidden" id="w-step2">
            <h3 id="step2-title">Exchange Codes</h3>
            <p class="subtitle">Scan this QR on the other device OR copy the code.</p>
            
            <div class="flex-center">
                <div id="qrcode" class="qr-container"></div>
            </div>
            
            <div class="input-area">
                <textarea id="out-code" readonly onclick="this.select()"></textarea>
            </div>
            
            <button class="btn btn-secondary" onclick="copyCode()">üìã Copy to Clipboard</button>
            <div style="height: 20px;"></div>
            
            <p class="subtitle" id="step2-instruction">Once you have the code from the other device...</p>
            <button class="btn btn-primary" onclick="goToStep3()">Next Step ‚ûî</button>
        </div>

        <div class="card hidden" id="w-step3">
            <h3>Final Connection</h3>
            <p class="subtitle">Paste the code received from the other device below.</p>
            <textarea id="in-code" placeholder="Paste code here..."></textarea>
            <div class="btn-group">
                <button class="btn btn-secondary" onclick="document.getElementById('in-code').value=''">Clear</button>
                <button class="btn btn-primary" onclick="finalizeHandshake()">üöÄ Connect</button>
            </div>
        </div>
    </div>

    <!-- MAIN CALL UI -->
    <div id="call-ui" class="full-screen">
        <div id="file-progress-bar"></div>
        
        <div class="video-grid">
            <video id="remoteVideo" autoplay playsinline></video>
        </div>

        <div id="local-wrapper">
            <video id="localVideo" autoplay muted playsinline></video>
        </div>

        <div class="dock">
            <button class="dock-btn" onclick="toggleMic()" id="btn-mic">üéôÔ∏è</button>
            <button class="dock-btn" onclick="toggleCam()" id="btn-cam">üì∑</button>
            <button class="dock-btn" onclick="toggleScreen()" id="btn-share">üñ•Ô∏è</button>
            <button class="dock-btn" onclick="toggleChat()">
                üí¨ <span id="chat-badge" class="badge">!</span>
            </button>
            <button class="dock-btn" onclick="triggerFile()">üìé</button>
            <button class="dock-btn off" onclick="endCall()">‚ùå</button>
        </div>

        <!-- CHAT DRAWER -->
        <div id="chat-drawer" class="drawer">
            <div class="drawer-header">
                <span>MESSAGES</span>
                <button onclick="toggleChat()" style="background:none;border:none;color:white;font-size:20px;cursor:pointer;">‚úï</button>
            </div>
            <div id="chat-content" class="chat-content">
                <div style="text-align:center; opacity:0.5; font-size:12px;">Messages are end-to-end encrypted.</div>
            </div>
            <div class="chat-input-area">
                <input type="text" id="chat-input" class="chat-input" placeholder="Type a message...">
                <button onclick="sendMsg()" class="btn-primary" style="width:50px; border-radius:12px; border:none;">‚û§</button>
            </div>
        </div>
        
        <!-- Hidden Inputs -->
        <input type="file" id="file-input" class="hidden" onchange="handleFileSelect()">
    </div>

    <script>
        // --- CONFIGURATION ---
        // Enhanced STUN servers for better PC-to-Mobile connectivity
        const rtcConfig = {
            iceServers: [
                { urls: "stun:stun.l.google.com:19302" },
                { urls: "stun:stun1.l.google.com:19302" },
                { urls: "stun:stun2.l.google.com:19302" },
                { urls: "stun:global.stun.twilio.com:3478" } // Highly reliable
            ],
            iceCandidatePoolSize: 10
        };

        // --- STATE ---
        let pc, dataChannel, localStream;
        let role = null; // 'host' or 'guest'
        let fileChunks = [], fileMeta = null;
        let isChatOpen = false;

        // --- UI UTILS ---
        const $ = id => document.getElementById(id);
        const show = id => $(id).classList.remove('hidden');
        const hide = id => $(id).classList.add('hidden');
        
        // --- WIZARD LOGIC ---
        async function startFlow(selectedRole) {
            role = selectedRole;
            hide('w-intro');
            show('w-step1');
            
            try {
                // Initialize Media
                localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                $('localVideo').srcObject = localStream;
                
                // Initialize PeerConnection
                pc = new RTCPeerConnection(rtcConfig);
                
                // Add Tracks
                localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
                
                // Event Handlers
                pc.ontrack = (event) => {
                    $('remoteVideo').srcObject = event.streams[0];
                };
                
                pc.onconnectionstatechange = () => {
                    if (pc.connectionState === 'connected') {
                        hide('wizard');
                        show('call-ui');
                        playNotification();
                    }
                    if (pc.connectionState === 'disconnected') {
                        alert("Connection lost.");
                    }
                };

                // Setup Data Channel
                if (role === 'host') {
                    setupDataChannel(pc.createDataChannel("chat"));
                    createOffer();
                } else {
                    pc.ondatachannel = (event) => setupDataChannel(event.channel);
                    // Guest waits for step 3 to input Host code first
                    hide('w-step1');
                    show('w-step3'); 
                    $('step2-title').innerText = "Send Answer";
                    $('step2-instruction').innerText = "Share this code back to the Host.";
                }

            } catch (err) {
                alert("Error accessing camera/mic: " + err.message);
                location.reload();
            }
        }

        async function createOffer() {
            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);
            waitForIceAndShowCode();
        }

        async function generateAnswer() {
            const answer = await pc.createAnswer();
            await pc.setLocalDescription(answer);
            waitForIceAndShowCode();
        }

        function waitForIceAndShowCode() {
            // We wait for ICE gathering to complete to ensure the code works on all networks
            // In a server-based app we would trickle, but for copy-paste/QR we need the full blob
            if (pc.iceGatheringState === 'complete') {
                displayCode();
            } else {
                pc.onicecandidate = (event) => {
                    if (!event.candidate) {
                        displayCode();
                    }
                };
            }
        }

        function displayCode() {
            const code = JSON.stringify(pc.localDescription);
            const compressed = LZString.compressToBase64(code);
            
            $('out-code').value = compressed;
            
            // Generate QR
            $('qrcode').innerHTML = "";
            // We strip protocol to save space, just raw data
            new QRCode($('qrcode'), {
                text: compressed,
                width: 180,
                height: 180,
                colorDark : "#000000",
                colorLight : "#ffffff",
                correctLevel : QRCode.CorrectLevel.L
            });
            $('qrcode').classList.add('show');
            
            hide('w-step1');
            show('w-step2');
        }

        function copyCode() {
            const txt = $('out-code');
            txt.select();
            txt.setSelectionRange(0, 99999);
            navigator.clipboard.writeText(txt.value).then(() => {
                alert("Code copied! Send it to the other person.");
            }).catch(err => {
                alert("Manual copy required due to browser permission.");
            });
        }

        function goToStep3() {
            hide('w-step2');
            show('w-step3');
            if (role === 'guest') {
                // Guest has already generated answer at this point logic-wise? 
                // No, guest flow is: 
                // 1. Input Host Code
                // 2. Generate Answer
                // 3. Show Answer
                // My logic above in startFlow was slightly off for guest. Let's fix.
            }
        }

        async function finalizeHandshake() {
            const input = $('in-code').value.trim();
            if (!input) return alert("Please paste the code.");
            
            try {
                const decompressed = LZString.decompressFromBase64(input);
                if(!decompressed) throw new Error("Invalid Code");
                
                const desc = new RTCSessionDescription(JSON.parse(decompressed));
                await pc.setRemoteDescription(desc);

                if (role === 'guest' && pc.signalingState === 'have-remote-offer') {
                    // If guest just set remote offer, now generate answer
                    hide('w-step3');
                    show('w-step1'); // Show loading
                    generateAnswer(); // This will eventually trigger displayCode -> step2
                } else {
                    // Host set remote answer, or guest finalize? 
                    // Host sets remote answer -> connection establishes -> auto-hide wizard
                }
            } catch (e) {
                alert("Invalid Code or Connection Error: " + e.message);
            }
        }

        // --- DATA CHANNEL (Chat/File) ---
        function setupDataChannel(channel) {
            dataChannel = channel;
            dataChannel.onopen = () => console.log("Data Channel Open");
            dataChannel.onmessage = handleDataMessage;
        }

        function handleDataMessage(event) {
            const data = event.data;
            
            // Handle binary (File)
            if (data instanceof ArrayBuffer) {
                handleFileChunk(data);
                return;
            }

            // Handle Text
            try {
                const msg = JSON.parse(data);
                if (msg.type === 'chat') {
                    appendMsg(msg.text, 'received');
                    if (!isChatOpen) {
                        $('chat-badge').style.display = 'block';
                        playNotification();
                    }
                } else if (msg.type === 'file-meta') {
                    fileMeta = msg;
                    fileChunks = [];
                    appendMsg(`üìÇ Receiving <b>${fileMeta.name}</b>...`, 'received');
                }
            } catch (e) { console.error(e); }
        }

        // --- CHAT LOGIC ---
        function toggleChat() {
            const d = $('chat-drawer');
            isChatOpen = !isChatOpen;
            if (isChatOpen) {
                d.classList.add('open');
                $('chat-badge').style.display = 'none';
                setTimeout(() => $('chat-input').focus(), 300);
            } else {
                d.classList.remove('open');
            }
        }

        function sendMsg() {
            const input = $('chat-input');
            const text = input.value.trim();
            if (!text || !dataChannel) return;
            
            dataChannel.send(JSON.stringify({ type: 'chat', text: text }));
            appendMsg(text, 'sent');
            input.value = '';
        }

        function appendMsg(text, type) {
            const div = document.createElement('div');
            div.className = `msg ${type}`;
            div.innerHTML = text; // Allow innerHTML for links
            $('chat-content').appendChild(div);
            $('chat-content').scrollTop = $('chat-content').scrollHeight;
        }

        $('chat-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMsg();
        });

        // --- FILE SHARING ---
        function triggerFile() { $('file-input').click(); }

        async function handleFileSelect() {
            const file = $('file-input').files[0];
            if (!file || !dataChannel) return;

            dataChannel.send(JSON.stringify({ type: 'file-meta', name: file.name, size: file.size, type: file.type }));
            appendMsg(`üì§ Sending <b>${file.name}</b>...`, 'sent');

            const chunkSize = 16384; // 16KB safety limit
            const buffer = await file.arrayBuffer();
            let offset = 0;

            // Simple loop for sending
            while (offset < buffer.byteLength) {
                const chunk = buffer.slice(offset, offset + chunkSize);
                dataChannel.send(chunk);
                offset += chunkSize;
                
                // Update UI progress
                const percent = (offset / buffer.byteLength) * 100;
                $('file-progress-bar').style.width = percent + '%';
                
                // Small delay to prevent buffer overflow
                await new Promise(r => setTimeout(r, 1));
            }
            
            $('file-progress-bar').style.width = '0%';
            appendMsg(`‚úÖ Sent <b>${file.name}</b>`, 'sent');
        }

        function handleFileChunk(buffer) {
            fileChunks.push(buffer);
            const currentSize = fileChunks.reduce((acc, chunk) => acc + chunk.byteLength, 0);
            const percent = (currentSize / fileMeta.size) * 100;
            $('file-progress-bar').style.width = percent + '%';

            if (currentSize >= fileMeta.size) {
                const blob = new Blob(fileChunks, { type: fileMeta.type });
                const url = URL.createObjectURL(blob);
                appendMsg(`üíæ <a href="${url}" download="${fileMeta.name}">${fileMeta.name}</a>`, 'received');
                fileChunks = [];
                $('file-progress-bar').style.width = '0%';
            }
        }

        // --- MEDIA CONTROLS ---
        function toggleMic() {
            const track = localStream.getAudioTracks()[0];
            track.enabled = !track.enabled;
            $('btn-mic').innerHTML = track.enabled ? 'üéôÔ∏è' : 'üîá';
            $('btn-mic').classList.toggle('off', !track.enabled);
        }

        function toggleCam() {
            const track = localStream.getVideoTracks()[0];
            track.enabled = !track.enabled;
            $('btn-cam').innerHTML = track.enabled ? 'üì∑' : 'üö´';
            $('btn-cam').classList.toggle('off', !track.enabled);
        }

        async function toggleScreen() {
            const btn = $('btn-share');
            if (btn.classList.contains('active')) {
                // Stop Sharing
                const videoTrack = localStream.getVideoTracks()[0];
                const sender = pc.getSenders().find(s => s.track.kind === 'video');
                if (sender) sender.replaceTrack(videoTrack);
                btn.classList.remove('active');
            } else {
                // Start Sharing
                try {
                    const stream = await navigator.mediaDevices.getDisplayMedia({ video: true });
                    const screenTrack = stream.getVideoTracks()[0];
                    const sender = pc.getSenders().find(s => s.track.kind === 'video');
                    if (sender) sender.replaceTrack(screenTrack);
                    
                    btn.classList.add('active');
                    screenTrack.onended = () => toggleScreen(); // Handle UI stop
                } catch (e) {
                    console.error("Screen share cancelled");
                }
            }
        }

        function endCall() {
            if (pc) pc.close();
            location.reload();
        }

        function playNotification() {
            // Simple beep
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.connect(gain);
            gain.connect(ctx.destination);
            osc.frequency.value = 500;
            gain.gain.value = 0.1;
            osc.start();
            setTimeout(() => osc.stop(), 200);
        }

        // --- DRAGGABLE LOCAL VIDEO ---
        const dragItem = $('local-wrapper');
        let active = false;
        let currentX, currentY, initialX, initialY;
        let xOffset = 0, yOffset = 0;

        dragItem.addEventListener("touchstart", dragStart, false);
        dragItem.addEventListener("touchend", dragEnd, false);
        dragItem.addEventListener("touchmove", drag, false);
        dragItem.addEventListener("mousedown", dragStart, false);
        dragItem.addEventListener("mouseup", dragEnd, false);
        dragItem.addEventListener("mousemove", drag, false);

        function dragStart(e) {
            if (e.type === "touchstart") {
                initialX = e.touches[0].clientX - xOffset;
                initialY = e.touches[0].clientY - yOffset;
            } else {
                initialX = e.clientX - xOffset;
                initialY = e.clientY - yOffset;
            }
            if (e.target === dragItem || dragItem.contains(e.target)) active = true;
        }

        function dragEnd(e) {
            initialX = currentX;
            initialY = currentY;
            active = false;
        }

        function drag(e) {
            if (active) {
                e.preventDefault();
                if (e.type === "touchmove") {
                    currentX = e.touches[0].clientX - initialX;
                    currentY = e.touches[0].clientY - initialY;
                } else {
                    currentX = e.clientX - initialX;
                    currentY = e.clientY - initialY;
                }
                xOffset = currentX;
                yOffset = currentY;
                setTranslate(currentX, currentY, dragItem);
            }
        }

        function setTranslate(xPos, yPos, el) {
            el.style.transform = `translate3d(${xPos}px, ${yPos}px, 0)`;
        }
    </script>
</body>
</html>
